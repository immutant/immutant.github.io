<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>immutant.messaging.pipeline documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.1.4 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide EAP 6.4.x-current"><a href="guide-EAP.html"><div class="inner"><span>EAP 6.4.x</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3 current"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3 branch"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.quartz.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>quartz</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*current-step*"><div class="inner"><span>*current-step*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*next-step*"><div class="inner"><span>*next-step*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*pipeline*"><div class="inner"><span>*pipeline*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-fanout"><div class="inner"><span>fanout</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-halt"><div class="inner"><span>halt</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-pipeline"><div class="inner"><span>pipeline</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-retry"><div class="inner"><span>retry</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-step"><div class="inner"><span>step</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-stop"><div class="inner"><span>stop</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">immutant.messaging.pipeline</h2><div class="doc"><div class="markdown"><p>Provides functions for creating and managing pipelines. A pipeline is a composition of functions (&ldquo;steps&rdquo;), where each function is passed the result of the previous function, dereferenced if needed. It is built on top of Immutant&rsquo;s messaging subsystem, allowing each step to have multiple processing threads, and to be automatically load balanced across a cluster.</p><p>The <code><a href="immutant.messaging.pipeline.html#var-pipeline">pipeline</a></code> function takes a unique (within the scope of the application) name, one or more single-arity functions, and optional kwarg options, returning a function that places its argument onto the pipeline when called. The resulting pipeline-fn optionally returns a delay that can be used to retrieve the result of the pipeline execution.</p><p>Each function can be optionally be wrapped with metadata that provides options for how that particular function is handled (see the &lsquo;step&rsquo; fn below).</p><p>Example:</p>
<pre><code>(require &#39;[immutant.pipeline <code>:as</code> pl])

(defn calculate-foo [m]
  ...
  (assoc m <code>:foo</code> value))

(defn save-data [m]
  ...)

;; create a pipeline
(defonce foo-pipeline
  (pl/pipeline &quot;foo&quot; ;; pipelines must be named
    (pl/step calculate-foo <code>:concurrency</code> 5) ;; run this step with 5 threads
    (pl/step #(update-in % [<code>:bar</code>] + (<code>:foo</code> %)) <code>:name</code> <code>:update-bar</code>) ;; give this step a name
    save-data ;; a &#39;vanilla&#39; step
    <code>:concurrency</code> 2 ;; run all steps with 2 threads (unless overridden)
    <code>:error-handler</code> (fn [ex m] ;; do something special with errors, and retry
                     ...
                     (pl/retry (update-in m [<code>:retry-count</code>] (fnil inc 0))))))

;; put data onto the front pipeline
(foo-pipeline {<code>:bar</code> 1 <code>:ham</code> &quot;biscuit&quot;})

;; put data onto the pipeline at a given step
(foo-pipeline {<code>:bar</code> 1 <code>:foo</code> 42 <code>:ham</code> &quot;gravy&quot;} <code>:step</code> <code>:update-bar</code>)

;; get the result
(deref (foo-pipeline {<code>:bar</code> 1 <code>:ham</code> &quot;biscuit&quot;}) 1000 <code>::timeout</code>!)

;; optional - it will automatically be stopped on undeploy
(pl/stop foo-pipeline)
</code></pre></div></div><div class="public anchor" id="var-*current-step*"><h3>*current-step*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>The name of the current pipeline step. Will be bound within the pipeline steps and error handlers.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L83">view source</a></div></div><div class="public anchor" id="var-*next-step*"><h3>*next-step*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>The name of the next pipeline step. Will be bound within the pipeline steps and error handlers.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L88">view source</a></div></div><div class="public anchor" id="var-*pipeline*"><h3>*pipeline*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>The currently active pipeline fn. Will be bound within the pipeline steps and error handlers.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L78">view source</a></div></div><div class="public anchor" id="var-fanout"><h3>fanout</h3><div class="usage"><code>(fanout xs)</code></div><div class="doc"><div class="markdown"><p>A function that takes a seq and places each item in it on the pipeline at the next step.</p><p>This halts pipeline execution for the current message, but continues execution for each seq element. Note that a pipeline that uses this function cannot be correctly derefenced, since the deref will only get the first value to finish the pipeline.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L115">view source</a></div></div><div class="public anchor" id="var-halt"><h3>halt</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Halts pipeline processing for a given message if returned from any handler function.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L105">view source</a></div></div><div class="public anchor" id="var-pipeline"><h3>pipeline</h3><div class="usage"><code>(pipeline pl-name &amp; args)</code></div><div class="doc"><div class="markdown"><p>Creates a pipeline function.</p><p>It takes a unique (within the scope of the application) name, one or more single-arity functions, and optional kwarg options, and returns a function that places its argument onto the pipeline when called. If <code>:result-ttl</code> is &gt; -1, it returns a delayed value that can be derefed to get the result of the pipeline execution.</p><p>The following options are supported, and must follow the step functions as either kwarg arguments or a map [default]:</p>
<ul>
  <li><code>:concurrency</code> the number of threads to use for <em>each</em> step. Can be  overridden on a per-step basis - see the &lsquo;step&rsquo;  function. [#cores]</li>
  <li><code>:error-handler</code> a function that will be called when any step raises  an exception. It will be passed the exception and  the argument to the step. Without an error-handler,  the default HornetQ retry semantics will be  used. Can be overridden on a per-step basis - see  the &lsquo;step&rsquo; function. [nil]</li>
  <li><code>:result-ttl</code> the time-to-live for the final pipeline result,  in millis. Set to 0 for &ldquo;forever&rdquo;, -1 to disable  returning the result via a delay [1 hour]</li>
  <li><code>:step-deref-timeout</code> the amount of time to wait when dereferencing  the result of a step that returns a delay,  in millis. Can be overridden on a per-step basis -  see the &lsquo;step&rsquo; function. [10 seconds]</li>
  <li><code>:durable?</code> whether messages persist across restarts [true]</li>
</ul><p>During the execution of each step and each error-handler call, the following vars are bound:</p>
<ul>
  <li><code>*pipeline*</code> the pipeline (as a fn) that is being executed</li>
  <li><code>*current-step*</code> the name of the currently executing step</li>
  <li><code>*next-step*</code> the name of the next step in the pipeline</li>
</ul><p>This function is <em>not</em> idempotent. Attempting to create a pipeline with the same name as an existing pipeline will raise an error.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L312">view source</a></div></div><div class="public anchor" id="var-retry"><h3>retry</h3><div class="usage"><code>(retry m)</code><code>(retry m step)</code></div><div class="doc"><div class="markdown"><p>Retries the message at the current step, or at the given step.</p><p>Can only be called from within an <code>:error-handler</code>.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L301">view source</a></div></div><div class="public anchor" id="var-step"><h3>step</h3><div class="usage"><code>(step f &amp; opts)</code></div><div class="doc"><div class="markdown"><p>Wraps the given function with the given options, returning a function.</p><p>The following options can be passed as kwargs or as a map [default]:</p>
<ul>
  <li><code>:name</code> a name to use for the step [the current index of the fn]</li>
  <li><code>:concurrency</code> the number of threads to use, overriding the pipeline  setting [#cores]</li>
  <li><code>:decode?</code> if false, the raw message object will be passed to  this step [true]</li>
  <li><code>:error-handler</code> an error handler function that can override the  pipeline setting [nil]</li>
  <li><code>:fanout?</code> applies the fanout fn to the result of the step.  See <code><a href="immutant.messaging.pipeline.html#var-fanout">fanout</a></code> for more details [false]</li>
  <li><code>:step-deref-timeout</code> the amount of time to wait when dereferencing  the result of the step if it returns a delay,  in ms. Overrides the pipeline setting [10 seconds]</li>
</ul></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L266">view source</a></div></div><div class="public anchor" id="var-stop"><h3>stop</h3><div class="usage"><code>(stop pl)</code></div><div class="doc"><div class="markdown"><p>Destroys a pipeline.</p><p><code>pl</code> can either be the pipeline fn returned by <code><a href="immutant.messaging.pipeline.html#var-pipeline">pipeline</a></code>, or the name of the pipeline.</p><p>Typically not necessary since it will be done for you when your app is undeployed.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.1.4/messaging/src/immutant/messaging/pipeline.clj#L380">view source</a></div></div></div></body></html>