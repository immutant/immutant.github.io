<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>immutant.web.async documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.0.0-beta2 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch current"><a href="immutant.web.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="immutant.web.async.html#var-as-channel"><div class="inner"><span>as-channel</span></div></a></li><li class="depth-1"><a href="immutant.web.async.html#var-Channel"><div class="inner"><span>Channel</span></div></a></li><li class="depth-2 branch"><a href="immutant.web.async.html#var-close"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>close</span></div></a></li><li class="depth-2 branch"><a href="immutant.web.async.html#var-open.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>open?</span></div></a></li><li class="depth-2 branch"><a href="immutant.web.async.html#var-originating-request"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>originating-request</span></div></a></li><li class="depth-2"><a href="immutant.web.async.html#var-send.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>send!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">immutant.web.async</h2><div class="doc"><div class="markdown"><p>Provides a common interface for WebSockets and HTTP streaming.</p></div></div><div class="public anchor" id="var-as-channel"><h3>as-channel</h3><div class="usage"><code>(as-channel request &amp; callbacks)</code></div><div class="doc"><div class="markdown"><p>Converts the current ring <code>request</code> in to an asynchronous channel.</p><p>The type of channel created depends on the request - if the request is a Websocket upgrade request, a Websocket channel will be created. Otherwise, an HTTP stream channel is created. You interact with both channel types through the <code><a href="immutant.web.async.html#var-Channel">Channel</a></code> protocol, and through the given <code>callbacks</code>.</p><p>The callbacks common to both channel types are:</p>
<ul>
  <li><code>:on-open</code> - <code>(fn [ch] ...)</code> - called when the channel is  available for sending. Will only be invoked once.</li>
  <li><code>:on-error</code> - <code>(fn [ch throwable] ...)</code> - Called for any error  that occurs in relation to the channel. If the error  requires the channel to be closed, <code>:on-close</code> will also be invoked.  To handle <code><a href="immutant.web.async.html#var-send.21">send!</a></code> errors separately, provide it a completion  callback.</li>
  <li><code>:on-close</code> - <code>(fn [ch {<code>:keys</code> [code reason]}] ...)</code> -  called for <em>any</em> close, including a call to <code><a href="immutant.web.async.html#var-close">close</a></code>, but will  only be invoked once. <code>ch</code> will already be closed by the time  this is invoked.</li>
</ul><p><code>code</code> and <code>reason</code> will be the numeric closure code and text reason,  respectively, if the channel is a WebSocket  (see <a href="http://tools.ietf.org/html/rfc6455#section-7.4">http://tools.ietf.org/html/rfc6455#section-7.4</a>). Both will be nil  for HTTP streams.</p><p>If the channel is a Websocket, the following callback is also used:</p>
<ul>
  <li><code>:on-message</code> - <code>(fn [ch message] ...)</code> - Called for each message  from the client. <code>message</code> will be a <code>String</code> or <code>byte[]</code></li>
</ul><p>When the ring handler is called during a WebSocket upgrade request, any headers returned in the response map are ignored, but any changes to the session are applied.</p><p>Returns a ring response map, at least the <code>:body</code> of which <em>must</em> be returned in the response map from the calling ring handler.</p></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-beta2/web/src/immutant/web/async.clj#L87">view source</a></div></div><div class="public anchor" id="var-Channel"><h3>Channel</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Streaming channel interface</p></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-close"><h3>close</h3><div class="usage"><code>(close ch)</code></div><div class="doc"><div class="markdown"><p>Gracefully close the channel.</p><p>This will trigger the <code>:on-close</code> callback if one is registered. with <code><a href="immutant.web.async.html#var-as-channel">as-channel</a></code>.</p></div></div></div><div class="public anchor" id="var-open.3F"><h3>open?</h3><div class="usage"><code>(open? ch)</code></div><div class="doc"><div class="markdown"><p>Is the channel open?</p></div></div></div><div class="public anchor" id="var-originating-request"><h3>originating-request</h3><div class="usage"><code>(originating-request ch)</code></div><div class="doc"><div class="markdown"><p>Returns the request map for the request that initiated the channel.</p></div></div></div><div class="public anchor" id="var-send.21"><h3>send!</h3><div class="usage"><code>(send! ch message)</code><code>(send! ch message options)</code></div><div class="doc"><div class="markdown"><p>Send a message to the channel, asynchronously.</p><p><code>message</code> can either be a String or byte[]. If it is a String, it will be  encoded to the character set of the response for HTTP streams, and as UTF-8  for WebSockets.</p><p>The following options are supported [default]:</p>
<ul>
  <li><code>:close?</code> - if <code>true</code>, the channel will be closed when the send completes.  Setting this to <code>true</code> on the first send to an HTTP stream channel  will cause it to behave like a standard HTTP response, and <em>not</em> chunk  the response. [false]</li>
  <li><code>:on-complete</code> - <code>(fn [throwable] ...)</code> - called when the send  attempt has completed. The success of the attempt is signaled by the  passed value, i.e. if throwable is nil. If the error requires the  channel to be closed, the <code><a href="immutant.web.async.html#var-as-channel">as-channel</a></code> <code>:on-close</code> callback will  also be invoked. If this callback throws an exception, it will be  reported to the <code><a href="immutant.web.async.html#var-as-channel">as-channel</a></code> <code>:on-error</code> callback [<code>#(when % (throw %))</code>]</li>
</ul><p>Returns nil if the channel is closed when the send is initiated, true otherwise. If the channel is already closed, <code>:on-complete</code> won&rsquo;t be invoked.</p></div></div></div></div></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-beta2/web/src/immutant/web/async.clj#L32">view source</a></div></div></div></body></html>