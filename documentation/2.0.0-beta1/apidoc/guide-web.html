<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Immutant 2.0.0-beta1 API documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.0.0-beta1 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-3"><a href="immutant.web.websocket.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websocket</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class='namespace-index guide' id='content'><div class='markdown doc'><div class="guide-content"><h1>Web Guide</h1><div class="description"><span>Running Clojure web applications and WebSockets</span></div><div id="toc"><ul><li><a href="#h5230"><span>The Namespaces</span></a></li><li><a href="#h5231"><span>A sample REPL session</span></a><ul><li><a href="#h5232"><span>Common Usage</span></a></li><li><a href="#h5233"><span>Advanced Usage</span></a></li></ul></li><li><a href="#h5234"><span>Virtual Hosts</span></a></li><li><a href="#h5235"><span>Advanced Undertow Configuration</span></a><ul><li><a href="#h5236"><span>SSL configuration</span></a></li></ul></li><li><a href="#h5237"><span>Handler Types</span></a></li><li><a href="#h5238"><span>Development Mode</span></a></li><li><a href="#h5239"><span>WebSockets</span></a><ul><li><a href="#h5240"><span>The WebSocket Handshake</span></a></li></ul></li><li><a href="#h5241"><span>Feature Demo</span></a></li></ul></div><p>The <code>org.immutant/web</code> library changed quite a bit from Immutant 1.x to 2.x, both its API and its foundation: the <a href="http://undertow.io/">Undertow</a> web server. Among other things, this resulted in <a href="https://github.com/ptaoussanis/clojure-web-server-benchmarks">much better performance</a> (~35% more throughput than v1.1.1) and built-in support for websockets.</p><h2 id="h5230">The Namespaces</h2><p>The primary namespace, <a href="immutant.web.html">immutant.web</a>, includes the two main functions you&rsquo;ll use to run your handlers:</p>
<ul>
  <li><code>run</code> - runs your handler in a specific environment, responding to  web requests matching a given host, port, path and virtual host. The  handler may be either a <a href="https://github.com/ring-clojure/ring/wiki">Ring</a> function, Servlet instance, or  Undertow HttpHandler</li>
  <li><code>stop</code> - stops your handler[s]</li>
</ul><p>Also included:</p>
<ul>
  <li><code>run-dmc</code> - runs your handler in <em>Development Mode</em> (the &lsquo;C&rsquo; is silent)</li>
  <li><code>server</code> - provides finer-grained control over the embedded web  server hosting your handler[s].</li>
</ul><p>The <a href="immutant.web.middleware.html">immutant.web.middleware</a> namespace includes two Ring middleware functions:</p>
<ul>
  <li><code>wrap-session</code> - enables session sharing among your Ring handler and  its websockets, as well as automatic session replication when your  app is deployed to a WildFly or EAP cluster.</li>
  <li><code>wrap-development</code> - included automatically by <code>run-dmc</code>, this  aggregates some middleware handy during development.</li>
</ul><p><a href="http://en.wikipedia.org/wiki/WebSocket">WebSockets</a> are created using the <a href="immutant.web.websocket.html">immutant.web.websocket</a> namespace, which includes the following:</p>
<ul>
  <li><code>Channel</code> - a protocol for WebSocket interaction.</li>
  <li><code>Handshake</code> - a protocol for obtaining attributes of the initial  upgrade request</li>
  <li><code>wrap-websocket</code> - middleware to attach websocket callback functions  to a Ring handler</li>
</ul><p>The <a href="immutant.web.undertow.html">immutant.web.undertow</a> namespace exposes tuning options for Undertow, the ability to open additional listeners, and flexible SSL configuration.</p><h2 id="h5231">A sample REPL session</h2><p>Now, let&rsquo;s fire up a REPL and work through some of the features of the library.</p><p>If you haven&rsquo;t already, you should read through the <a href="guide-installation.html">installation</a> guide and require the <code>immutant.web</code> namespace at a REPL to follow along:</p>
<pre><code class="clojure">(require &#39;[immutant.web :refer :all])
</code></pre><h3 id="h5232">Common Usage</h3><p>First, you&rsquo;ll need a <a href="https://github.com/ring-clojure/ring/wiki">Ring</a> handler. If you generated your app using a template from <a href="https://github.com/weavejester/compojure">Compojure</a>, <a href="http://www.luminusweb.net/">Luminus</a>, <a href="http://let-caribou.in/">Caribou</a> or some other Ring-based library, yours will be associated with the <code>:handler</code> key of your <code>:ring</code> map in your <code>project.clj</code> file. Of course, a far less fancy handler will suffice:</p>
<pre><code class="clojure">(defn app [request]
  {:status 200
   :body &quot;Hello world!&quot;})
</code></pre><p>To make the app available at <a href="http://localhost:8080/">http://localhost:8080/</a>, do this:</p>
<pre><code class="clojure">(run app)
</code></pre><p>Which, if we make the default values explicit, is equivalent to this:</p>
<pre><code class="clojure">(run app {:host &quot;localhost&quot; :port 8080 :path &quot;/&quot;})
</code></pre><p>Or, since <a href="immutant.web.html#var-run">run</a> takes options as either an explicit map or keyword arguments (kwargs), this:</p>
<pre><code class="clojure">(run app :host &quot;localhost&quot; :port 8080 :path &quot;/&quot;)
</code></pre><p>The options passed to <code>run</code> determine the URL used to invoke your handler: <code>http://{host}:{port}{path}</code></p><p>To replace your <code>app</code> handler with another, just call run again with the same options, and it&rsquo;ll replace the old handler with the new:</p>
<pre><code class="clojure">(run (fn [_] {:status 200 :body &quot;hi!&quot;}))
</code></pre><p>To stop the handler, do this:</p>
<pre><code class="clojure">(stop)
</code></pre><p>Which is equivalent to this:</p>
<pre><code class="clojure">(stop {:host &quot;localhost&quot; :port 8080 :path &quot;/&quot;})
</code></pre><p>Or like <code>run</code>, if you prefer kwargs, this:</p>
<pre><code class="clojure">(stop :host &quot;localhost&quot; :port 8080 :path &quot;/&quot;)
</code></pre><p>Alternatively, you can save the return value from <code>run</code> and pass it to stop to stop your handler.</p>
<pre><code class="clojure">(def server (run app {:port 4242 :path &quot;/hello&quot;}))
...
(stop server)
</code></pre><p>Stopping your handlers isn&rsquo;t strictly necessary if you&rsquo;re content to just let the JVM exit, but it can be handy at a REPL.</p><h3 id="h5233">Advanced Usage</h3><p>The <code>run</code> function returns a map that includes the options passed to it, so you can thread <code>run</code> calls together, useful when your application runs multiple handlers. For example,</p>
<pre><code class="clojure">(def everything (-&gt; (run ello)
                  (assoc :path &quot;/owdy&quot;)
                  (-&gt;&gt; (run owdy))
                  (merge {:path &quot;/&quot; :port 8081})
                  (-&gt;&gt; (run ola))))
</code></pre><p>The above actually creates two Undertow web server instances: one serving requests for the <code>ello</code> and <code>owdy</code> handlers on port 8080, and one serving <code>ola</code> responses on port 8081.</p><p>You can stop all three apps (and shutdown the two web servers) like so:</p>
<pre><code class="clojure">(stop everything)
</code></pre><p>Alternatively, you could stop only the <code>ola</code> app like so:</p>
<pre><code class="clojure">(stop {:path &quot;/&quot; :port 8081})
</code></pre><p>You could even omit <code>:path</code> since &ldquo;/&rdquo; is the default. And because ola was the only app running on the web server listening on port 8081, it will be shutdown automatically.</p><h2 id="h5234">Virtual Hosts</h2><p>The <code>:host</code> option denotes the IP interface to which the web server is bound, which may not be publicly accessible. You can extend access to other hosts using the <code>:virtual-host</code> option, which takes either a single hostname or multiple:</p>
<pre><code class="clojure">(run app :virtual-host &quot;yourapp.com&quot;)
(run app :virtual-host [&quot;app.io&quot; &quot;app.us&quot;])
</code></pre><p>Multiple applications can run on the same <code>:host</code> and <code>:port</code> as long as each has a unique combination of <code>:virtual-host</code> and <code>:path</code>.</p><h2 id="h5235">Advanced Undertow Configuration</h2><p>The <a href="immutant.web.undertow.html">immutant.web.undertow</a> namespace includes a number of composable functions that turn a map of various keywords into a map containing an <code>io.undertow.Undertow$Builder</code> instance mapped to the keyword, <code>:configuration</code>. So Undertow configuration is exposed via a composite of these functions called <a href="immutant.web.undertow.html#var-options">immutant.web.undertow/options</a>.</p><p>For a contrived example, say we wanted our handler to run with 42 worker threads, and listen for requests on two ports, 8888 and 9999. Weird, but possible. To do it, we&rsquo;ll need to pass the <code>:port</code> option twice, in a manner of speaking:</p>
<pre><code class="clojure">(require &#39;[immutant.web.undertow :refer (options)])
(def opts (-&gt; (options :port 8888 :worker-threads 42)
            (assoc :port 9999)
            options))
(run app opts)
</code></pre><h3 id="h5236">SSL configuration</h3><p>SSL and Java is a notoriously gnarly combination that is way outside the scope of this guide. Ultimately, Undertow needs either a <code>javax.net.ssl.SSLContext</code> or a <code>javax.net.ssl.KeyManager[]</code> and an optional <code>javax.net.ssl.TrustManager[]</code>.</p><p>You may also pass a <code>KeyStore</code> instance or a path to one on disk, and the <code>SSLContext</code> will be created for you. For example,</p>
<pre><code class="clojure">(run app (immutant.web.undertow/options
           :ssl-port 8443
           :keystore &quot;/path/to/keystore.jks&quot;
           :key-password &quot;password&quot;))
</code></pre><p>Another option is to use the <a href="https://github.com/aphyr/less-awful-ssl">less-awful-ssl</a> library; maybe something along these lines:</p>
<pre><code class="clojure">(def context (less.awful.ssl/ssl-context &quot;client.pkcs8&quot; &quot;client.crt&quot; &quot;ca.crt&quot;))
(run app (immutant.web.undertow/options
           :ssl-port 8443
           :ssl-context context))
</code></pre><p>Client authentication may be specified using the <code>:client-auth</code> option, where possible values are <code>:want</code> and <code>:need</code>. Or, if you&rsquo;re fancy, <code>:requested</code> and <code>:required</code>.</p><h2 id="h5237">Handler Types</h2><p>Though the handlers you run will typically be Ring functions, you can also pass any valid implementation of <code>javax.servlet.Servlet</code> or <code>io.undertow.server.HttpHandler</code>. For an example of the former, here&rsquo;s a very simple <a href="https://github.com/pedestal/pedestal">Pedestal</a> service running on Immutant:</p>
<pre><code class="clojure">(ns testing.hello.service
  (:require [io.pedestal.http :as http]
            [io.pedestal.http.route.definition :refer [defroutes]]
            [ring.util.response :refer [response]]
            [immutant.web :refer [run]]))

(defn home-page [request] (response &quot;Hello World!&quot;))
(defroutes routes [[[&quot;/&quot; {:get home-page}]]])
(def service {::http/routes routes})

(defn start [options]
  (run (::http/servlet (http/create-servlet service)) options))
</code></pre><h2 id="h5238">Development Mode</h2><p>The <a href="immutant.web.html#var-run-dmc">run-dmc</a> macro resulted from a desire to provide a no-fuss way to enjoy all the benefits of REPL-based development. Before calling <code>run</code>, <code>run-dmc</code> will first ensure that your Ring handler is var-quoted and wrapped in the <code>reload</code> and <code>stacktrace</code> middleware from the <code>ring-devel</code> library (which must be included among your <code>[:profiles :dev :dependencies]</code> in <code>project.clj</code>). It&rsquo;ll then open your app in a browser.</p><p>Both <code>run</code> and <code>run-dmc</code> accept the same options. You can even mix them within a single threaded call.</p><h2 id="h5239">WebSockets</h2><p>Also included in the <code>org.immutant/web</code> library is the <a href="immutant.web.websocket.html">immutant.web.websocket</a> namespace, which includes the <code>wrap-websocket</code> function that attaches a map of callback functions to your Ring handler. Though it looks like Ring middleware, it actually returns an <code>HttpHandler</code> instead of a function, so it must come last in your middleware chain.</p><p>The valid websocket event keywords and their corresponding callback signatures are as follows, where channel is an instance of the <code>Channel</code> protocol, and handshake is an instance of <code>Handshake</code>:</p>
<pre><code class="clojure">  :on-message (fn [channel message])
  :on-open    (fn [channel handshake])
  :on-close   (fn [channel {:keys [code reason]}])
  :on-error   (fn [channel throwable])
</code></pre><p>To create your websocket endpoint, pass the result from <code>wrap-websocket</code> to <code>immutant.web/run</code>. Here&rsquo;s an example that asynchronously returns the upper-cased equivalent of whatever message it receives:</p>
<pre><code class="clojure">(ns whatever
  (:require [immutant.web             :as web]
            [immutant.web.websocket   :as ws]
            [ring.middleware.resource :refer [wrap-resource]]
            [ring.util.response       :refer [redirect]]
            [clojure.string           :refer [upper-case]]))

(defn create-websocket []
  (web/run
    (-&gt; (fn [{c :context}] (redirect (str c &quot;/index.html&quot;)))
      (wrap-resource &quot;public&quot;)
      (ws/wrap-websocket {:on-message (fn [c m] (ws/send! c (upper-case m)))}))
    {:path &quot;/ws&quot;}))
</code></pre><p>After running the above, a request to <a href="http://localhost:8080/ws">http://localhost:8080/ws</a> should return a 302 redirect to <a href="http://localhost:8080/ws/index.html">http://localhost:8080/ws/index.html</a>. Assuming the <code>wrap-resource</code> middleware can find <code>public/index.html</code> in your classpath (typically in your project&rsquo;s <code>resources/</code> dir), a <code>&lt;script&gt;</code> that attempts to open a WebSocket connection to <a href="ws://localhost:8080/ws">ws://localhost:8080/ws</a> should work, and an upper-cased version of any text the browser sends should be returned to it through that WebSocket.</p><p>Note the <code>:path</code> argument applies to both the Ring handler and the WebSocket, distinguished only by the request protocol, e.g. <code>http://</code> vs <code>ws://</code>.</p><h3 id="h5240">The WebSocket Handshake</h3><p>Often, applications require access to data in the original upgrade request associated with a WebSocket connection, perhaps for user authentication or some such. That data is made available via the <a href="immutant.web.websocket.html#var-Handshake">immutant.web.websocket/Handshake</a> protocol, an instance of which is passed to the <code>:on-open</code> callback.</p><p>In particular, you can access all the headers sent in the upgrade request, and if you&rsquo;re using the <code>wrap-session</code> middleware, you can even access any session data stored on behalf of the user by the Ring handler. Here&rsquo;s a contrived example in which the Ring handler stores a random id in the session that is then sent back to the user when he opens a WebSocket:</p>
<pre><code class="clojure">(ns whatever
  (:require [immutant.web             :as web]
            [immutant.web.websocket   :as ws]
            [immutant.web.middleware  :refer [wrap-session]]
            [ring.util.response       :refer [response]]))

(def callbacks {:on-open (fn [c h] (ws/send! c (:id (ws/session h))))}

(defn share-session-with-websocket []
  (web/run
    (-&gt; (fn [ :session}]
          (-&gt; id response (assoc :session {:id id})))
      (wrap-session)
      (ws/wrap-websocket callbacks))
    {:path &quot;/ws&quot;}))
</code></pre><h2 id="h5241">Feature Demo</h2><p>We maintain a Leiningen project called the <a href="https://github.com/immutant/feature-demo">Immutant Feature Demo</a> demonstrating all the Immutant namespaces, including examples of simple <a href="https://github.com/immutant/feature-demo/blob/thedeuce/src/demo/web.clj">Web</a> and <a href="https://github.com/immutant/feature-demo/blob/thedeuce/src/demo/websocket.clj">WebSocket</a> apps.</p><p>You should be able to clone it somewhere, cd there, and <code>lein run</code>.</p><p>Have fun!</p></div></div></div><script src="assets/jquery.syntax.min.js" type="text/javascript"></script><script src="assets/immutant.js" type="text/javascript"></script></body></html>