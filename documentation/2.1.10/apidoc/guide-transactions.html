<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Immutant 2.1.10 API documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.1.10 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide EAP 6.4.x-current"><a href="guide-EAP.html"><div class="inner"><span>EAP 6.4.x</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3 branch"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.quartz.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>quartz</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class='namespace-index guide' id='content'><div class='markdown doc'><div class="guide-content"><h1>Transactions Guide</h1><div class="description"><span>Providing support for distributed (XA) transactions</span></div><div id="toc"><ul><li><a href="#h3137"><span>Defining a transaction</span></a></li><li><a href="#h3138"><span>Transaction Scope</span></a></li><li><a href="#h3139"><span>Pseudo-Transactions</span></a></li><li><a href="#h3140"><span>JDBC DataSources in WildFly</span></a></li><li><a href="#h3141"><span>Transaction Configuration</span></a></li></ul></div><p>Immutant encapsulates the distributed transaction support provided by <a href="http://www.jboss.org/narayana">Narayana</a> within the <a href="immutant.transactions.html">immutant.transactions</a> namespace. This allows you to define XA (2PC) transactions involving Immutant components either inside the WildFly application server or embedded within your standalone apps.</p><p>A <em>distributed</em> transaction is one in which multiple types of resources may participate. The most common example of a transactional resource is a relational database, but in Immutant both caching (backed by <a href="http://infinispan.org">Infinispan</a>) and messaging (backed by <a href="http://www.jboss.org/hornetq">HornetQ</a>) resources are transactional. Technically speaking, they provide implementations of the <a href="http://en.wikipedia.org/wiki/X/Open_XA">XA protocol</a>, and any resource that does may participate in an Immutant transaction.</p><p>This allows your application to say, tie the success of a SQL database update or the storage of an entry on a replicated cache to the delivery of a message to a remote queue, i.e. the message is only sent if the database and cache update successfully. If any single component of an XA transaction fails, all of them rollback.</p><h2 id="h3137">Defining a transaction</h2><p>If you&rsquo;re familiar with <a href="http://www.oracle.com/technetwork/java/javaee/jta/index.html">JTA</a>, we make a <code>TransactionManager</code> available via the <a href="immutant.transactions.html#var-manager">manager</a> function, and everything else provided by the library is mostly a syntactic sugary glaze slathered on that instance. For example, the <a href="immutant.transactions.html#var-transaction">transaction</a> macro will query the manager to see if a transaction is active. If so, it&rsquo;ll simply invoke its body. Otherwise, it&rsquo;ll start a new transaction, execute its body, and commit the transaction unless either an exception is caught or <a href="immutant.transactions.html#var-set-rollback-only">set-rollback-only</a> is called, in which case the transaction is rolled back. Either way, it relies on the transactional components within the body to automatically enlist themselves as XA resources. For example,</p>
<pre><code class="clojure">(def queue (msg/queue &quot;/queue/test&quot;))
(def cache (csh/cache &quot;test&quot; :transactional true))

(transaction
  (msg/publish queue &quot;message&quot;)
  (csh/swap-in! cache :count (fnil inc 0)))
</code></pre><p>Here, we&rsquo;ve combined a messaging call and a caching call into a single, atomic operation. Either both succeed or neither succeeds. Note that the cache had to be created with its <code>:transactional</code> flag set. The publish function will detect an active transaction and create an XA-capable context with which to send the message. If you pass a context for publish to use, be sure its <code>:xa?</code> flag is set if you intend to publish within a transaction.</p><h2 id="h3138">Transaction Scope</h2><p>When transactional components interact, the state of a transaction when a particular function is invoked isn&rsquo;t always predictable. For example, can a function that requires a transaction assume one has been started prior to its invocation? In JEE container-managed persistence, a developer answers these questions using the <code>@TransactionAttribute</code> annotation.</p><p>But annotations are gross, my friend!</p><p>So in Immutant, <a href="https://docs.oracle.com/javaee/7/tutorial/transactions003.htm">JEE transaction attributes</a> are represented as Clojure macros. In fact, the <a href="immutant.transactions.html#var-transaction">transaction</a> macro is merely an alias for <a href="immutant.transactions.scope.html#var-required">immutant.transactions.scope/required</a>, which is the implicit attribute used in JEE. There are a total of 6 macros in the <a href="immutant.transactions.scope.html">immutant.transactions.scope</a> namespace:</p>
<ul>
  <li><code>required</code>- Execute within current transaction, if any, otherwise  start a new one, execute, commit or rollback</li>
  <li><code>requires-new</code>- Suspend current transaction, if any, start a new  one, execute, commit or rollback, and resume the suspended one</li>
  <li><code>not-supported</code> - Suspend current transaction, if any, and execute  without a transaction</li>
  <li><code>supports</code>- Execute the body whether there&rsquo;s a transaction or not;  may lead to unpredictable results</li>
  <li><code>mandatory</code> - Toss an exception if there&rsquo;s no active transaction</li>
  <li><code>never</code> - Toss an exception if there is an active transaction</li>
</ul><p>These macros give the developer complete declarative control over the transactional semantics of their application as its functional chunks are combined.</p><h2 id="h3139">Pseudo-Transactions</h2><p>While messaging and caching resources in Immutant are XA capable, not all data sources are, and even a JDBC library providing an XA driver is insufficient outside of an application server.</p><p>But non-XA resources like Datomic or JDBC connections running outside of a container can still participate in a distributed transaction as long as their local transaction is the <strong>last</strong> operation in the body defining the XA transaction. This technique, known as a <a href="http://www.theserverside.com/news/1363664/Java-Pseudo-Transactions-With-Non-Transactional-Resources">pseudo transaction</a>, relies on the non-XA resource throwing an exception in the event of failure. This exception will cause the operations on the XA resources to rollback. For example,</p>
<pre><code class="clojure">(immutant.transactions/transaction
  (immutant.messaging/publish queue message)
  (immutant.caching/swap-in! cache :count (fnil inc 0))
  (clojure.java.jdbc/with-db-transaction [t spec]
    (write-sql-things t data)))
</code></pre><p>Note that we define a local transaction using <code>with-db-transaction</code> assuming <code>write-sql-things</code> invokes multiple SQL statements, so that they all rollback if any throw an exception. If you&rsquo;re only calling a single SQL statement, e.g. one INSERT, the local transaction isn&rsquo;t necessary.</p><h2 id="h3140">JDBC DataSources in WildFly</h2><p>Within WildFly, it&rsquo;s possible to use real, honest-to-goodness JDBC XA datasources, thereby obviating the need for pseudo transactions.</p><p>Configuring datasources in WildFly is <a href="https://docs.jboss.org/author/display/WFLY8/DataSource+configuration">beyond the scope of this guide</a>, but once you have the JNDI name for the XA datasource, you can pass that as the <code>:name</code> option in the &ldquo;database spec&rdquo; required by <a href="https://github.com/clojure/java.jdbc">java.jdbc</a> or any of its many DSL wrappers.</p><p>Unfortunately, <code>java.jdbc</code> attempts to invoke operations on the connection returned from the datasource bound to that name that are illegal within an XA transaction, specifically: <code>commit</code>, <code>rollback</code>, and <code>setAutoCommit</code>. It&rsquo;s up to the <code>TransactionManager</code> to commit/rollback a distributed transaction, not its constituents. So Immutant provides a factory function, <a href="immutant.transactions.jdbc.html#var-factory">immutant.transactions.jdbc/factory</a>, that wraps the connection to turn those calls into no-ops. This means the database spec you pass to <a href="https://github.com/clojure/java.jdbc">java.jdbc</a> should look something like this:</p>
<pre><code class="clojure">(def db-spec {:factory immutant.transactions.jdbc/factory
              :name &quot;java:jboss/datasources/ExampleDS&quot;})
</code></pre><h2 id="h3141">Transaction Configuration</h2><p>Narayana will look for a configuration file on the classpath called <code>jbossts-properties.xml</code>. There is a default one embedded within its distribution jar that you can use as a basis for your own.</p><p>One of the properties, in particular, has an annoying default value. The location of the persistent object store is <code>PutObjectStoreDirHere</code> by default. This can be overridden with the following system property if you&rsquo;d prefer not to create the XML file:</p>
<pre><code>&quot;-DObjectStoreEnvironmentBean.objectStoreDir=target/ObjectStore&quot;
</code></pre><p>The &ldquo;now obsolete but somewhat equivalent and occasionally still relevant&rdquo; analog to the above is this:</p>
<pre><code>&quot;-Dcom.arjuna.ats.arjuna.objectstore.objectStoreDir=target/ObjectStore&quot;
</code></pre><p>So you may need to set them both.</p></div></div></div><script src="assets/jquery.syntax.min.js" type="text/javascript"></script><script src="assets/immutant.js" type="text/javascript"></script></body></html>