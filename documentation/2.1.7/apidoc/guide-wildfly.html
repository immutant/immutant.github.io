<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Immutant 2.1.7 API documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.1.7 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide EAP 6.4.x-current"><a href="guide-EAP.html"><div class="inner"><span>EAP 6.4.x</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3 branch"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.quartz.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>quartz</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class='namespace-index guide' id='content'><div class='markdown doc'><div class="guide-content"><h1>WildFly Guide</h1><div class="description"><span>Deploying your app to WildFly</span></div><div id="toc"><ul><li><a href="#h3384"><span>WildFly</span></a></li><li><a href="#h3385"><span>The lein-immutant plugin</span></a><ul><li><a href="#h3386"><span>Creating a war file</span></a></li><li><a href="#h3387"><span>org.immutant/wildfly</span></a></li><li><a href="#h3388"><span>Running tests in-container</span></a></li></ul></li><li><a href="#h3389"><span>Deploying to WildFly</span></a></li><li><a href="#h3390"><span>Running Ring Handlers in WildFly</span></a></li><li><a href="#h3391"><span>Initialization Caveats</span></a></li><li><a href="#h3392"><span>Logging in WildFly</span></a></li><li><a href="#h3393"><span>Async Issues with WildFly 8.2</span></a></li><li><a href="#h3394"><span>Concurrent Requests When Using Sessions</span></a></li></ul></div><p>One of <a href="/news/2014/04/02/the-deuce/">the primary goals for Immutant 2.x</a> was the removal of the ancient AS7 fork we lugged around in Immutant 1.x. This eliminates the need to install and deploy your apps into a &ldquo;container&rdquo; to use the Immutant libraries.</p><p>But here&rsquo;s the trade-off: app server containers can simplify the configuration of features &ndash; e.g. security, monitoring, clustering &ndash; for all the applications deployed to it.</p><p>Further, each Immutant library automatically benefits from being clustered. Without any changes to your code, deploying your app to WildFly yields the following enhanced functionality:</p>
<ul>
  <li>Web session replication</li>
  <li>Load-balanced message distribution</li>
  <li>Highly-available &ldquo;singleton&rdquo; scheduled jobs</li>
  <li>Flexible cache replication</li>
  <li>Multiple polyglot app deployments</li>
</ul><p>So we wanted to <em>facilitate</em> app server deployment but not actually <em>require</em> it. And we didn&rsquo;t want to require any tweaking of the stock &ldquo;vanilla&rdquo; configuration provided by the app server. This meant using the standard deployment protocol for all Java app servers: war files.</p><p>Theoretically, this implies you could stick the Immutant jars in any ol&rsquo; war file and deploy them to any ol&rsquo; Java app server. Unfortunately, Immutant&rsquo;s ability to work both outside and inside a container requires some &ldquo;glue code&rdquo; that must be aware of the container&rsquo;s implementation.</p><p>For this reason, Immutant intentionally uses the same services as <a href="http://wildfly.org">WildFly</a>, the community-supported upstream project for the <em>next</em> version of the commercially-supported <a href="http://www.jboss.org/products/eap/overview/">Red Hat JBoss Enterprise Application Platform</a> (EAP) product.</p><p>If you are using the <em>current</em> version of EAP (6.4.x), everything here applies, but you&rsquo;ll want to take a look at our <a href="guide-EAP.html">EAP guide</a> as well.</p><h2 id="h3384">WildFly</h2><p>There are lots of resources for installing and administering WildFly, and frankly, we love being able to refer you to those rather than write them ourselves. :)</p><p>Thankfully, installing WildFly is trivial:</p>
<pre><code>$ wget http://download.jboss.org/wildfly/9.0.2.Final/wildfly-9.0.2.Final.zip
$ unzip wildfly-9.0.2.Final.zip
</code></pre><p>Downloading and unpacking it somewhere are all there is to it. Running it is easy, too:</p>
<pre><code>$ wildfly-9.0.2.Final/bin/standalone.sh
</code></pre><p>Pass it <code>-h</code> to see what options it supports. The main one you&rsquo;ll use is <code>-c</code> which refers to one of its config files beneath <code>standalone/configuration</code>. The default config doesn&rsquo;t include HornetQ, for example, so to use <code>immutant.messaging</code>, you&rsquo;ll need to start WildFly as follows:</p>
<pre><code>$ wildfly-9.0.2.Final/bin/standalone.sh -c standalone-full.xml
</code></pre><p>And if you want clustering&hellip;</p>
<pre><code>$ wildfly-9.0.2.Final/bin/standalone.sh -c standalone-full-ha.xml
</code></pre><p>You can create your own, of course, too.</p><h2 id="h3385">The lein-immutant plugin</h2><p>The <a href="https://github.com/immutant/lein-immutant/">lein-immutant</a> plugin was fundamental to developing apps for Immutant 1.x. In 2.x, it&rsquo;s only required if you wish to deploy your Clojure apps to WildFly, and its formerly numerous tasks have been reduced to two: <code>immutant war</code> and <code>immutant test</code>. Add the latest version to the <code>:plugins</code> section of your <code>project.clj</code> to install it, e.g.</p>
<pre><code>:plugins [[lein-immutant &quot;2.1.0&quot;]]
</code></pre><p><em>Note:</em> If you are a <a href="http://boot-clj.com/">boot</a> user, we have a [boot-immutant plugin] as well.</p><h3 id="h3386">Creating a war file</h3><p>Immutant war files require a bit of special config: a couple of jars of the aforementioned &ldquo;glue code&rdquo;, a properties file to trigger that code, a couple of tags in <code>web.xml</code>, and a <code>jboss-deployment-structure.xml</code> to link the deployment to the necessary WildFly modules. You&rsquo;ll find copies of the latter two files beneath <code>target/</code> after you run the war task in your project, along with an <em>uberjar</em> containing your app plus its dependencies, and finally a war file packaging it all up together:</p>
<pre><code>$ lein immutant war
</code></pre><p>The <code>immutant war</code> task provides a number of configuration options, all of which can be specified both in the <code>[:immutant :war]</code> path of <code>project.clj</code> and as command line arguments, with the latter taking precedence.</p><p>For a detailed description of each option:</p>
<pre><code>$ lein help immutant deployment
</code></pre><p>For a brief listing of just the command line switches:</p>
<pre><code>$ lein help immutant war
</code></pre><h3 id="h3387">org.immutant/wildfly</h3><p>Automatically included in an Immutant war file is a library that makes the <a href="immutant.wildfly.html">immutant.wildfly</a> namespace available to your app. This contains functions that are only relevant when your app is running in the <a href="http://wildfly.org">WildFly</a> container. If your app relies on these functions and you need to compile them outside the container, you must explicitly depend on <code>org.immutant/wildfly</code> in your <code>project.clj</code>:</p>
<pre><code class="clojure">(defproject some-project &quot;1.2.3&quot;
  ...
  :dependencies [[org.immutant/immutant &quot;2.1.7&quot;]
                 [org.immutant/wildfly &quot;2.1.7&quot;]]
</code></pre><h3 id="h3388">Running tests in-container</h3><p>Although you no longer need to run a container to test your applications&rsquo; use of the Immutant libraries, it is still possible via the <code>immutant test</code> task.</p>
<pre><code>$ lein immutant test -j /srv/wildfly
</code></pre><p>It will find all the tests (or <a href="https://github.com/marick/Midje">Midje</a> facts, or <a href="http://jayfields.com/expectations/">Expectations</a> expectations) in a project, fire up the <a href="http://wildfly.org">WildFly</a> instance installed at <code>/srv/wildfly</code>, deploy the project to it, connect to its REPL, run all the tests, undeploy the app, shutdown the WildFly process, and display the results, returning success only if all tests pass.</p><p>Because it conveniently runs all your tests inside the app server, a successful run yields a high confidence that your code will run correctly when it counts – in production, when deployed to the same app server. For this reason, it may also be useful to run it on your app&rsquo;s Continuous Integration host whenever any changes are committed.</p><p>The server config and log output for the WildFly instance used for the test run can be found beneath your project&rsquo;s <code>target/isolated-wildfly/</code> directory.</p><p>Similar to the <code>immutant war</code> task, configuration of the <code>immutant
test</code> task may be specified in either the <code>[:immutant :test]</code> path of <code>project.clj</code> or as command line arguments. For a detailed description of each option:</p>
<pre><code>$ lein help immutant testing
</code></pre><p>And for a brief listing of just the command line switches:</p>
<pre><code>$ lein help immutant test
</code></pre><h2 id="h3389">Deploying to WildFly</h2><p>Once you have a war file, it&rsquo;s a simple matter of making it known to your WildFly server. The easiest way to do that is to copy it to a directory that is monitored by WildFly for artifacts to deploy. Assuming you installed WildFly in <code>/srv/wildfly</code>, that path is <code>/srv/wildfly/standalone/deployments</code>. For example:</p>
<pre><code>$ lein immutant war
$ cp target/myapp.war /srv/wildfly/standalone/deployments
</code></pre><p>Alternatively,</p>
<pre><code>$ lein immutant war -o /srv/wildfly
</code></pre><p>If not already running, fire up WildFly to see your deployed app:</p>
<pre><code>$ /srv/wildfly/bin/standalone.sh -c standalone-full.xml
</code></pre><h2 id="h3390">Running Ring Handlers in WildFly</h2><p>When running inside WildFly, the <code>:host</code> and <code>:port</code> options to <code>immutant.web/run</code> are silently ignored since your handlers are mounted on WildFly&rsquo;s internal Undertow server, bound to whatever host/port it&rsquo;s been configured for.</p><p>Also, the URL for your handler will include a context path corresponding to the base name of your deployed war file. This context path will prefix whatever <code>:path</code> option you specified. To override this and set your context path to &ldquo;/&rdquo; instead, name your war file <code>ROOT.war</code>:</p>
<pre><code>$ lein immutant war -o /srv/wildfly -n ROOT
</code></pre><h2 id="h3391">Initialization Caveats</h2><p>There are two issues to be aware of with regards to application initialization in WildFly:</p>
<ul>
  <li><p>Your <code>:main</code> function <em>must</em> return when initialization is  complete - deployment will not finish until it does. If it doesn&rsquo;t  return within 4 minutes, the deployment will be aborted. If you need  more than 4 minutes, you can override the default with  <code>-Dwunderboss.deployment.timeout=&lt;n seconds&gt;</code>. Note that if you set  that to more than 5 minutes, you will also need to increase  WildFly&rsquo;s own coarser grained deployment timeout with  <code>-Djboss.as.management.blocking.timeout=&lt;m seconds&gt;</code>.</p></li>
  <li><p>Any <code>immutant.web/run</code> calls <em>have</em> to occur before <code>:main</code>  returns. A limitation of the JavaEE specification prevents us from  registering any servlets after that point.</p></li>
</ul><h2 id="h3392">Logging in WildFly</h2><p>To learn about how logging works when inside WildFly, along with how to change the default configuration, see our <a href="guide-logging.html">logging guide</a>.</p><h2 id="h3393">Async Issues with WildFly 8.2</h2><p>Due to <a href="https://issues.jboss.org/browse/WFLY-3715">a locking issue around sessions</a>, HTTP streams have a couple of limitations in WildFly 8.2, namely:</p>
<ul>
  <li><a href="immutant.web.async.html#var-send.21">immutant.web.async/send!</a> calls to a stream are actually synchronous  instead of asynchronous</li>
  <li>you cannot pass a <code>:timeout</code> to <a href="immutant.web.async.html#var-as-channel">immutant.web.async/as-channel</a> -  doing so will trigger an exception</li>
</ul><p>We recommend you upgrade to WildFly 9.0.0 or newer if you intend to use HTTP streams.</p><h2 id="h3394">Concurrent Requests When Using Sessions</h2><p>In order to satisfy the JavaEE spec, WildFly serializes requests that share a session. This means if you are using a session, you can&rsquo;t have concurrent requests - requests will queue up waiting for the previous request to complete. This includes asynchronous requests, which means that a synchronous request may have to wait for a possibly long-running async request to complete.</p><p>In order to prevent this, you&rsquo;ll have to adjust the caching settings to allow concurrent access.</p><p>If using <code>standalone.xml</code> or <code>standalone-full.xml</code>, change the <code>web</code> cache container to:</p>
<pre><code>&lt;cache-container name=&quot;web&quot; default-cache=&quot;passivation&quot; module=&quot;org.wildfly.clustering.web.infinispan&quot;&gt;
  &lt;local-cache name=&quot;passivation&quot;&gt;
    &lt;locking isolation=&quot;READ_COMMITTED&quot;/&gt;
    &lt;transaction mode=&quot;BATCH&quot;/&gt;
    &lt;file-store passivation=&quot;true&quot; purge=&quot;false&quot;/&gt;
  &lt;/local-cache&gt;

  &lt;local-cache name=&quot;persistent&quot;&gt;
    &lt;locking isolation=&quot;READ_COMMITTED&quot;/&gt;
    &lt;transaction mode=&quot;BATCH&quot;/&gt;
    &lt;file-store passivation=&quot;false&quot; purge=&quot;false&quot;/&gt;
  &lt;/local-cache&gt;
&lt;/cache-container&gt;
</code></pre><p>Or, for <code>standalone-ha.xml</code> or <code>standalone-ha-full.xml</code>:</p>
<pre><code>&lt;cache-container name=&quot;web&quot; default-cache=&quot;repl&quot; module=&quot;org.wildfly.clustering.web.infinispan&quot;&gt;  
  &lt;transport lock-timeout=&quot;60000&quot;/&gt;  
  &lt;replicated-cache name=&quot;repl&quot; mode=&quot;ASYNC&quot; batching=&quot;true&quot;&gt;  
    &lt;transaction locking=&quot;OPTIMISTIC&quot;/&gt;  
    &lt;locking isolation=&quot;READ_COMMITTED&quot;/&gt;  
    &lt;file-store/&gt;  
  &lt;/replicated-cache&gt;  
&lt;/cache-container&gt;  
</code></pre><p>For more details on the plethora of available options, see the <a href="http://infinispan.org/docs/8.0.x/user_guide/user_guide.html#_transaction_modes">Infinispan User Guide</a>.</p></div></div></div><script src="assets/jquery.syntax.min.js" type="text/javascript"></script><script src="assets/immutant.js" type="text/javascript"></script></body></html>