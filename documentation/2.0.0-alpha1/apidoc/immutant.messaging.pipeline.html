<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><link href="css/docs.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>immutant.messaging.pipeline documentation</title></head><body><div id="header"><h2><a href="http://immutant.org/">Immutant Home</a></h2><h1><a href="index.html">Immutant 2.0.0-alpha1</a></h1></div><div class="sidebar" id="namespaces"><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2 branch"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3 current"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-3"><a href="immutant.web.websocket.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websocket</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*current-step*"><div class="inner"><span>*current-step*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*next-step*"><div class="inner"><span>*next-step*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-*pipeline*"><div class="inner"><span>*pipeline*</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-fanout"><div class="inner"><span>fanout</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-halt"><div class="inner"><span>halt</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-pipeline"><div class="inner"><span>pipeline</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-step"><div class="inner"><span>step</span></div></a></li><li class="depth-1"><a href="immutant.messaging.pipeline.html#var-stop"><div class="inner"><span>stop</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">immutant.messaging.pipeline</h2><div class="doc"><p>Provides functions for creating and managing pipelines. A pipeline is a composition of functions ("steps"), where each function is passed the result of the previous function, dereferenced if needed. It is built on top of Immutant's messaging subsystem, allowing each step to have multiple processing threads, and to be automatically load balanced across a cluster.</p><p>The <code><a href="immutant.messaging.pipeline.html#var-pipeline">pipeline</a></code> function takes a unique (within the scope of the application) name, one or more single-arity functions, and optional kwarg options, returning a function that places its argument onto the pipeline when called. The resulting pipeline-fn optionally returns a delay that can be used to retrieve the result of the pipeline execution.</p><p>Each function can be optionally be wrapped with metadata that provides options for how that particular function is handled (see the 'step' fn below).</p><p>Example:</p><pre>
&#40;require '&#91;immutant.pipeline <code>:as</code> pl&#93;&#41;

&#40;defn calculate-foo &#91;m&#93;
  ...
  &#40;assoc m <code>:foo</code> value&#41;&#41;

&#40;defn save-data &#91;m&#93;
  ...&#41;

;; create a pipeline
&#40;defonce foo-pipeline
  &#40;pl/pipeline &quot;foo&quot; ;; pipelines must be named
    &#40;pl/step calculate-foo <code>:concurrency</code> 5&#41; ;; run this step with 5 threads
    &#40;pl/step #&#40;update-in % &#91;<code>:bar</code>&#93; + &#40;<code>:foo</code> %&#41;&#41; <code>:name</code> <code>:update-bar</code>&#41; ;; give this step a name
    save-data ;; a 'vanilla' step
    <code>:concurrency</code> 2 ;; run all steps with 2 threads &#40;unless overridden&#41;
    <code>:error-handler</code> &#40;fn &#91;ex m&#93; ;; do something special with errors, and retry
                     ...
                     &#40;pl/&#42;pipeline&#42; m <code>:step</code> &#42;current-step&#42;&#41;&#41;&#41;&#41;

;; put data onto the front pipeline
&#40;foo-pipeline {<code>:bar</code> 1 <code>:ham</code> &quot;biscuit&quot;}&#41;

;; put data onto the pipeline at a given step
&#40;foo-pipeline {<code>:bar</code> 1 <code>:foo</code> 42 <code>:ham</code> &quot;gravy&quot;} <code>:step</code> <code>:update-bar</code>&#41;

;; get the result
&#40;deref &#40;foo-pipeline {<code>:bar</code> 1 <code>:ham</code> &quot;biscuit&quot;}&#41; 1000 <code>::timeout</code>!&#41;

;; optional - it will automatically be stopped on undeploy
&#40;pl/stop foo-pipeline&#41;
</pre></div><div class="public anchor" id="var-*current-step*"><h3>*current-step*</h3><div class="usage"></div><div class="doc"><p>The name of the current pipeline step. Will be bound within the pipeline steps and error handlers.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L83">view source</a></div></div><div class="public anchor" id="var-*next-step*"><h3>*next-step*</h3><div class="usage"></div><div class="doc"><p>The name of the next pipeline step. Will be bound within the pipeline steps and error handlers.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L88">view source</a></div></div><div class="public anchor" id="var-*pipeline*"><h3>*pipeline*</h3><div class="usage"></div><div class="doc"><p>The currently active pipeline fn. Will be bound within the pipeline steps and error handlers.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L78">view source</a></div></div><div class="public anchor" id="var-fanout"><h3>fanout</h3><div class="usage"><code>(fanout xs)</code></div><div class="doc"><p>A function that takes a seq and places each item in it on the pipeline at the next step.</p><p>This halts pipeline execution for the current message, but continues execution for each seq element. Note that a pipeline that uses this function cannot be correctly derefenced, since the deref will only get the first value to finish the pipeline.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L107">view source</a></div></div><div class="public anchor" id="var-halt"><h3>halt</h3><div class="usage"></div><div class="doc"><p>Halts pipeline processing for a given message if returned from any handler function.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L97">view source</a></div></div><div class="public anchor" id="var-pipeline"><h3>pipeline</h3><div class="usage"><code>(pipeline pl-name &amp; args)</code></div><div class="doc"><p>Creates a pipeline function.</p><p>It takes a unique (within the scope of the application) name, one or more single-arity functions, and optional kwarg options, and returns a function that places its argument onto the pipeline when called. If <code>:result-ttl</code> is > -1, it returns a delayed value that can be derefed to get the result of the pipeline execution.</p><p>The following options are supported, and must follow the step functions as either kwarg arguments or a map <em>[default]</em>:</p><ul><li><code>:concurrency</code>        the number of threads to use for <em>each</em> step. Can be                      overridden on a per-step basis - see the 'step'                      function. <em>[1]</em></li><li><code>:error-handler</code>      a function that will be called when any step raises                      an exception. It will be passed the exception and                      the argument to the step. Without an error-handler,                      the default HornetQ retry semantics will be                      used. Can be overridden on a per-step basis - see                      the 'step' function. <em>[nil]</em></li><li><code>:result-ttl</code>         the time-to-live for the final pipeline result,                      in millis. Set to 0 for "forever", -1 to disable                      returning the result via a delay <em>[1 hour]</em></li><li><code>:step-deref-timeout</code> the amount of time to wait when dereferencing                      the result of a step that returns a delay,                      in millis. Can be overridden on a per-step basis -                      see the 'step' function. <em>[10 seconds]</em></li><li><code>:durable</code>            whether messages persist across restarts <em>[true]</em></li></ul><p>During the execution of each step and each error-handler call, the following vars are bound:</p><ul><li><code>&#42;pipeline&#42;</code>      the pipeline (as a fn) that is being executed</li><li><code>&#42;current-step&#42;</code>  the name of the currently executing step</li><li><code>&#42;next-step&#42;</code>     the name of the next step in the pipeline</li></ul><p>This function is <em>not</em> idempotent. Attempting to create a pipeline with the same name as an existing pipeline will raise an error.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L290">view source</a></div></div><div class="public anchor" id="var-step"><h3>step</h3><div class="usage"><code>(step f &amp; opts)</code></div><div class="doc"><p>Wraps the given function with the given options, returning a function.</p><p>The following options can be passed as kwargs or as a map <em>[default]</em>:</p><ul><li><code>:name</code>                a name to use for the step <em>[the current index of the fn]</em></li><li><code>:concurrency</code>         the number of threads to use, overriding the pipeline                       setting <em>[1]</em></li><li><code>:decode?</code>             if false, the raw message object will be passed to                       this step <em>[true]</em></li><li><code>:error-handler</code>       an error handler function that can override the                       pipeline setting <em>[nil]</em></li><li><code>:fanout?</code>             applies the fanout fn to the result of the step.                       See <code><a href="immutant.messaging.pipeline.html#var-fanout">fanout</a></code> for more details <em>[false]</em></li><li><code>:step-deref-timeout</code>  the amount of time to wait when dereferencing                       the result of the step if it returns a delay,                       in ms. Overrides the pipeline setting <em>[10 seconds]</em></li></ul></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L254">view source</a></div></div><div class="public anchor" id="var-stop"><h3>stop</h3><div class="usage"><code>(stop pl)</code></div><div class="doc"><p>Destroys a pipeline.</p><p><code>pl</code> can either be the pipeline fn returned by <code><a href="immutant.messaging.pipeline.html#var-pipeline">pipeline</a></code>, or the name of the pipeline.</p><p>Typically not necessary since it will be done for you when your app is undeployed.</p></div><div class="src-link"><a href="https://github.com/immutant/immutant/tree/2.0.0-alpha1/messaging/src/immutant/messaging/pipeline.clj#L358">view source</a></div></div></div></body></html>