<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Immutant 2.0.0-alpha2 API documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.0.0-alpha2 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide Scheduling-current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-3"><a href="immutant.web.websocket.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websocket</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class='namespace-index guide' id='content'><div class='markdown doc'><div class="guide-content"><h1>Messaging Guide</h1><div class="description"><span>Simple creation and usage of distributed queues and topics</span></div><div id="toc"><ul><li><a href="#h5305"><span>The API</span></a><ul><li><a href="#h5306"><span>Some Examples</span></a></li></ul></li><li><a href="#h5307"><span>Remote contexts</span></a></li><li><a href="#h5308"><span>Reusing contexts</span></a></li><li><a href="#h5309"><span>HornetQ configuration</span></a></li><li><a href="#h5310"><span>More to come</span></a></li></ul></div><p>If you&rsquo;re coming from Immutant 1.x, you may notice that the artifact has been renamed (<code>org.immutant/immutant-messaging</code> is now <code>org.immutant/messaging</code>), and the API has changed a bit. We&rsquo;ll point out the notable API changes as we go.</p><h2 id="h5305">The API</h2><p>The messaging <a href="immutant.messaging.html">API</a> is backed by <a href="http://hornetq.jboss.org/">HornetQ</a>, which is an implementation of <a href="https://en.wikipedia.org/wiki/Java_Message_Service">JMS</a>. JMS provides two primary destination types: <em>queues</em> and <em>topics</em>. Queues represent point-to-point destinations, and topics publish/subscribe.</p><p>To use a destination, we need to get a reference to one via the <a href="immutant.messaging.html#var-queue">queue</a> or <a href="immutant.messaging.html#var-topic">topic</a> functions, depending on the type required. This will create the destination if it does not already exist. This is a bit different than the 1.x API, which provided a single <code>start</code> function for this, and determined the type of destination based on conventions around the provided name. In 2.x, we&rsquo;ve removed those naming conventions.</p><p>Once we have a reference to a destination, we can operate on it with the following functions:</p>
<ul>
  <li><a href="immutant.messaging.html#var-publish">publish</a> - sends a message to the destination</li>
  <li><a href="immutant.messaging.html#var-receive">receive</a> - receives a single message from the destination</li>
  <li><a href="immutant.messaging.html#var-listen">listen</a> - registers a function to be called each time a message  arrives at the destination</li>
</ul><p>If the destination is a queue, we can do synchronous messaging (<a href="https://en.wikipedia.org/wiki/Request-response">request-response</a>):</p>
<ul>
  <li><a href="immutant.messaging.html#var-respond">respond</a> - registers a function that receives each request, and  the returned value will be sent back to the requester</li>
  <li><a href="immutant.messaging.html#var-request">request</a> - sends a message to the responder</li>
</ul><p>Finally, to deregister listeners, responders, and destinations, we provide a single <a href="immutant.caching.html#var-stop">stop</a> function. This is another difference from 1.x - the <code>unlisten</code> and <code>stop</code> functions have been collapsed to <code>stop</code>.</p><h3 id="h5306">Some Examples</h3><p>You should follow the instructions in the <a href="guide-installation.html">installation</a> guide to set up a project using Immutant 2.x, and in addition to <code>org.immutant/messaging</code> add <code>[cheshire &quot;5.3.1&quot;]</code> to the project dependencies (we&rsquo;ll be encoding some messages as JSON in our examples below, so we&rsquo;ll go ahead and add <a href="https://github.com/dakrone/cheshire">cheshire</a> while we&rsquo;re at it). Then, fire up a REPL, and require the <code>immutant.messaging</code> namespace to follow along:</p>
<pre><code class="clojure">(require &#39;[immutant.messaging :refer :all])
</code></pre><p>First, let&rsquo;s create a queue:</p>
<pre><code class="clojure">(queue &quot;my-queue&quot;)
</code></pre><p>That will create the queue in the HornetQ broker for us. We&rsquo;ll need a reference to that queue to operate on it. Let&rsquo;s go ahead and store that reference in a var:</p>
<pre><code class="clojure">(def q (queue &quot;my-queue&quot;))
</code></pre><p>We can call <code>queue</code> any number of times - if the queue already exists, we&rsquo;re just grabbing a reference to it.</p><p>Now, let&rsquo;s register a listener on our queue. Let&rsquo;s just print every message we get:</p>
<pre><code class="clojure">(def listener (listen q println))
</code></pre><p>We can publish to that queue, and see that the listener gets called:</p>
<pre><code class="clojure">(publish q {:hi :there})
</code></pre><p>You&rsquo;ll notice that we&rsquo;re publishing a map there - we can publish pretty much any data structure as a message. By default, that message will be encoded using <a href="https://github.com/edn-format/edn">edn</a>. We also support other encodings, namely: <code>:fressian</code>, <code>:json</code>, and <code>:none</code>. We can choose a different encoding by passing an :encoding option to <code>publish</code>:</p>
<pre><code class="clojure">(publish q {:hi :there} :encoding :json)
</code></pre><p>If you want to use <code>:fressian</code> or <code>:json</code>, you&rsquo;ll need to add <code>org.clojure/data.fressian</code> or <code>cheshire</code> to your dependencies to enable them, respectively.</p><p>We passed our options to <code>publish</code> as keyword arguments, but they can also be passed as a map:</p>
<pre><code class="clojure">(publish q {:hi :there} {:encoding :json})
</code></pre><p>This holds true for any of the messaging functions that take options.</p><p>We&rsquo;re also passing the destination reference to <code>publish</code> instead of the destination name. That&rsquo;s a departure from 1.x, where you could just pass the destination name. Since we no longer have conventions about how queues and topics should be named, we can no longer determine the type of the destination from the name alone.</p><p>We can deregister the listener by either passing it to <code>stop</code> or calling <code>.close</code> on it:</p>
<pre><code class="clojure">(stop listener)
;; identical to
(.close listener)
</code></pre><p>Now let&rsquo;s take a look at synchronous messaging. Let&rsquo;s create a new queue for this (you&rsquo;ll want to use a dedicated queue for each responder) and register a responder that just increments the request:</p>
<pre><code class="clojure">(def sync-q (queue &quot;sync&quot;))

(def responder (respond sync-q inc))
</code></pre><p>Then, we make a request, which returns a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html">Future</a> that we can dereference:</p>
<pre><code class="clojure">@(request sync-q 1)
</code></pre><p>The responder is just a fancy listener, and can be deregistered the same way as a listener.</p><h2 id="h5307">Remote contexts</h2><p>To connect to a remote HornetQ instance, you&rsquo;ll need to create a remote context (via the <a href="immutant.messaging.html#var-context">context</a> function), and use it when getting a reference to the destination:</p>
<pre><code class="clojure">(with-open [context (context :host &quot;some-host&quot; :port 5445)]
  (publish
    (queue &quot;foo&quot; :context context)
    &quot;a message&quot;))
</code></pre><p>A few things to note about the above example:</p>
<ul>
  <li>We&rsquo;re using <code>with-open</code> because you need to close any contexts you make</li>
  <li>We&rsquo;re passing the context to <code>queue</code>, which causes <code>queue</code> to  just return a reference to the remote queue, <em>without</em> asking  HornetQ to create it. You&rsquo;ll need to make sure it already exists.</li>
  <li>We don&rsquo;t need to pass the context to <code>publish</code>, since it will  reuse the context that was used to create the destination  reference.</li>
</ul><h2 id="h5308">Reusing contexts</h2><p>By default, Immutant creates a new context object for each <code>publish</code>, <code>request</code> or <code>receive</code> call. Creating a context isn&rsquo;t free, and incurs some performance overhead. If you plan on calling any of those functions in a tight loop, you can gain some performance by creating the context yourself (via the <a href="immutant.messaging.html#var-context">context</a> function):</p>
<pre><code class="clojure">(with-open [context (context)]
  (let [q (queue &quot;foo&quot;)]
    (dotimes [n 10000]
      (publish q n :context context))))
</code></pre><h2 id="h5309">HornetQ configuration</h2><p>When used outside of WildFly, we configure <a href="http://hornetq.jboss.org/">HornetQ</a> via a pair of xml files. If you need to adjust any of the HornetQ <a href="https://docs.jboss.org/hornetq/2.4.0.Final/docs/user-manual/html_single/#server.configuration">configuration options</a>, you can provide a copy of one (or both) of those files (<code>hornetq-configuration.xml</code> and <code>hornetq-jms.xml</code>, which should be based off of the <a href="https://github.com/projectodd/wunderboss/blob/0.2.0/modules/messaging/src/main/resources/">default versions</a>) on your application&rsquo;s classpath and your copies will be used instead of the default ones. When making changes to these files, be careful about changing existing settings, as Immutant relies on some of them.</p><p>We&rsquo;ve also exposed a few HornetQ settings as system properties, namely:</p>
<table>
  <thead>
    <tr>
      <th>Property </th>
      <th>Description </th>
      <th>Default </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>hornetq.data.dir</code> </td>
      <td>The base directory for HornetQ to store its data files </td>
      <td><code>./hornetq-data/</code> </td>
    </tr>
    <tr>
      <td><code>hornetq.netty.port</code> </td>
      <td>The port that HornetQ will listen on for remote connections </td>
      <td><code>5445</code> </td>
    </tr>
    <tr>
      <td><code>hornetq.netty.host</code> </td>
      <td>The host that HornetQ will listen on for remote connections </td>
      <td><code>localhost</code> </td>
    </tr>
  </tbody>
</table><p>Note that any custom xml or system properties will be ignored when running inside WildFly - you&rsquo;ll need to make adjustments to the WildFly configuration to achieve similar effects.</p><h2 id="h5310">More to come</h2><p>That was just a brief introduction to the messaging API. There are features we&rsquo;ve yet to cover (durable topic subscriptions, transactional sessions)&hellip;</p></div></div></div><script src="assets/jquery.syntax.min.js" type="text/javascript"></script><script src="assets/immutant.js" type="text/javascript"></script></body></html>